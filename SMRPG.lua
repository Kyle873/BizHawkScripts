-- Data Tables
ItemNames =
{
    [0x05] = "Hammer",
    [0x06] = "Froggie Stick",
    [0x07] = "Nok Nok Shell",
    [0x08] = "Punch Glove",
    [0x09] = "Finger Shot",
    [0x0A] = "Cymbals",
    [0x0B] = "Chomp",
    [0x0C] = "Masher",
    [0x0D] = "Chomp Shell",
    [0x0E] = "Super Hammer",
    [0x0F] = "Hand Gun",
    [0x10] = "Whomp Glove",
    [0x11] = "Slap Glove",
    [0x12] = "Troopa Shell",
    [0x13] = "Parasol",
    [0x14] = "Hurly Glove",
    [0x15] = "Double Punch",
    [0x16] = "Ribbit Stick",
    [0x17] = "Spiked Link",
    [0x18] = "Mega Glove",
    [0x19] = "War Fan",
    [0x1A] = "Hand Cannon",
    [0x1B] = "Sticky Glove",
    [0x1C] = "Ultra Hammer",
    [0x1D] = "Super Slap",
    [0x1E] = "Drill Claw",
    [0x1F] = "Star Gun",
    [0x20] = "Sonic Cymbal",
    [0x21] = "Lazy Shell",
    [0x22] = "Frying Pan",
    [0x25] = "Shirt",
    [0x26] = "Pants",
    [0x27] = "Thick Shirt",
    [0x28] = "Thick Pants",
    [0x29] = "Mega Shirt",
    [0x2A] = "Mega Pants",
    [0x2B] = "Work Pants",
    [0x2C] = "Mega Cape",
    [0x2D] = "Happy Shirt",
    [0x2E] = "Happy Pants",
    [0x2F] = "Happy Cape",
    [0x30] = "Happy Shell",
    [0x31] = "Polka Dress",
    [0x32] = "Sailor Shirt",
    [0x33] = "Sailor Pants",
    [0x34] = "Sailor Cape",
    [0x35] = "Nautical Dress",
    [0x36] = "Courage Shell",
    [0x37] = "Fuzzy Shirt",
    [0x38] = "Fuzzy Pants",
    [0x39] = "Fuzzy Cape",
    [0x3A] = "Fuzzy Dress",
    [0x3B] = "Fire Shirt",
    [0x3C] = "Fire Pants",
    [0x3D] = "Fire Cape",
    [0x3E] = "Fire Shell",
    [0x3F] = "Fire Dress",
    [0x40] = "Hero Shirt",
    [0x41] = "Prince Pants",
    [0x42] = "Star Cape",
    [0x43] = "Heal Shell",
    [0x44] = "Royal Dress",
    [0x45] = "Super Shirt",
    [0x46] = "Lazy Shell",
    [0x4A] = "Zoom Shoes",
    [0x4B] = "Safety Badge",
    [0x4C] = "Jump Shoes",
    [0x4D] = "Safety Ring",
    [0x4E] = "Amulet",
    [0x4F] = "Scrooge Ring",
    [0x50] = "Exp Booster",
    [0x51] = "Attack Scarf",
    [0x52] = "Rare Scarf",
    [0x53] = "B'Tub Ring",
    [0x54] = "Antidote Pin",
    [0x55] = "Wake Up Pin",
    [0x56] = "Fearless Pin",
    [0x57] = "Trueform Pin",
    [0x58] = "Coin Trick",
    [0x59] = "Ghost Medal",
    [0x5A] = "Jinx Belt",
    [0x5B] = "Feather",
    [0x5C] = "Troopa Pin",
    [0x5D] = "Signal Ring",
    [0x5E] = "Quartz Charm",
    [0x60] = "Mushroom",
    [0x61] = "Mid Mushroom",
    [0x62] = "Max Mushroom",
    [0x63] = "Honey Syrup",
    [0x64] = "Maple Syrup",
    [0x65] = "Royal Syrup",
    [0x66] = "Pick Me Up",
    [0x67] = "Able Juice",
    [0x68] = "Bracer",
    [0x69] = "Energizer",
    [0x6A] = "Yoshi-Ade",
    [0x6B] = "Red Essence",
    [0x6C] = "KeroKero Cola",
    [0x6D] = "Yoshi Cookie",
    [0x6E] = "Pure Water",
    [0x6F] = "Sleepy Bomb",
    [0x70] = "Bad Mushroom",
    [0x71] = "Fire Bomb",
    [0x72] = "Ice Bomb",
    [0x73] = "Flower Tab",
    [0x74] = "Flower Jar",
    [0x75] = "Flower Box",
    [0x76] = "Yoshi Candy",
    [0x77] = "Froggie Drink",
    [0x78] = "Muku Cookie",
    [0x79] = "Elixer",
    [0x7A] = "Megaelixer",
    [0x7B] = "See Ya",
    [0x7C] = "Temple Key",
    [0x7D] = "Goodie Bag",
    [0x7E] = "Earlier Times",
    [0x7F] = "Freshen Up",
    [0x80] = "Rare Frog Coin",
    [0x81] = "Wallet",
    [0x82] = "Cricket Pie",
    [0x83] = "Rock Candy",
    [0x84] = "Castle Key 1",
    [0x86] = "Castle Key 2",
    [0x87] = "Bambino Bomb",
    [0x88] = "Sheep Attack",
    [0x89] = "Carbo Cookie",
    [0x8A] = "Shiny Stone",
    [0x8C] = "Room Key",
    [0x8D] = "Elder Key",
    [0x8E] = "Shed Key",
    [0x8F] = "Lamb's Lure",
    [0x90] = "Fright Bomb",
    [0x91] = "Mystery Egg",
    [0x92] = "Beetle Box",
    [0x93] = "Beetle Box",
    [0x94] = "Luck Jewel",
    [0x96] = "Soprano Card",
    [0x97] = "Alto Card",
    [0x98] = "Tenor Card",
    [0x99] = "Cystalline",
    [0x9A] = "Power Blast",
    [0x9B] = "Wilted Shroom",
    [0x9C] = "Rotten Mush",
    [0x9D] = "Moldy Mush",
    [0x9E] = "Seed",
    [0x9F] = "Fertilizer",
    [0xA0] = "Waste Basket",
    [0xA1] = "Big Boo Flag",
    [0xA2] = "Dry Bones Flag",
    [0xA3] = "Greaper Flag",
    [0xA4] = "Secret Game",
    [0xA6] = "Cricket Jam",
    [0xAC] = "Fireworks",
    [0xAE] = "Bright Card",
    [0xAF] = "Mushroom",
    [0xB0] = "Star Egg",
    [0xFF] = "Nothing"
}

for i = 0, 255 do
    if ItemNames[i] == nil then
        ItemNames[i] = "???"
    end
end

EnemyNames =
{
}

for i = 0, 255 do
    if EnemyNames[i] == nil then
        EnemyNames[i] = "???"
    end
end

-- Addresses
Address =
{
	-- Inventory / Items
	Items = 0x1F882,
	Equipment = 0x1F864,
	SpecialItems = 0x1F8A0,
	FP = 0x1F8B1,
	Coins = 0x1F8AF,
	FrogCoins = 0x1F8B3,
	
	-- Characters
	Characters = 0xFA90,

	-- World (TODO: Refind addresses)
	X = 0x12000,
	Y = 0x12002,
	Z = 0x12004,
	CurrentLocation = 0x109E5,
	Music = 0x11D00,
	SoundEffect = 0x11D01,
	Invincible = 0x13076,
	
	-- Battle
	Enemies = 0xFC00,
	Spell = 0x0539,
	JumpCounter = 0xE010,
	MysteryEggCounter = 0xE012,
	LambsLureCounter = 0xE013,
	LuckyJewelCounter = 0xE014,
	TotalXP = 0xFA02,
	TotalCoins = 0xFA04,
	BattleEvent = 0xFA1D,
}

-- Input
Input = {}
OldInput = {}
InputTimer = 0
RepeatDelay = 60

-- Menu
Open = true
Page = 1
Index = 1
SubIndex = 0

-- Clipboard
Clipboard = 0

-- Item/Character editing utility functions
function EditItem(id, item)
	memory.writebyte(Address.Items + id, item)
end

function EditEquipment(id, item)
	memory.writebyte(Address.Equipment + id, item)
end

function EditSpecialItem(id, item)
	memory.writebyte(Address.SpecialItems + id, item)
end

function EditChar(slot, offset, value)
	if offset == 0x1 or offset == 0x3 or offset == 0xA then -- HP, Max HP and Experience are 2 bytes
		memory.write_s16_le(Address.Characters + (slot * 0x14) + offset, memory.read_s16_le(Address.Characters + (slot * 0x14) + offset) + value)
	else
		memory.writebyte(Address.Characters + (slot * 0x14) + offset, memory.readbyte(Address.Characters + (slot * 0x14) + offset) + value)
	end
end

-- Menu utility functions
function GetOnOff(value)
	if value == 1 then
        return "On"
	elseif value == 0 then
        return "Off"
    else
        return "???"
    end
end

-- Drawing utility functions
-- TODO: Don't really need this anymore
function DrawBar(x, y, width, height, color)
	-- Prevent bar overflow
	if width > 100 then width = 100 end
	
	for y2 = 1, height do
		for x2 = 1, width do
			gui.drawPixel(x + x2, y + y2, color)
		end
	end
end

-- Menus
Menu =
{
	-- Main Menu
	{
		-- Box
		Width = 120,
		Height = 56,
		
		-- Menu
		{ Text = "Inventory", X = 32, Y = 16 },
		{ Text = "Character", X = 32, Y = 24 },
		{ Text = "Battle", X = 32, Y = 32 },
     -- { Text = "World", X = 32, Y = 40 },
	 -- { Text = "System", X = 32, Y = 48 },
	 -- { Text = "Sidequests", X = 32, Y = 56 },
	 -- { Text = "Story Events/Flags", X = 32, Y = 64 },
	 -- { Text = "World Map Locations", X = 32, Y = 72 },
	 -- { Text = "Battle Script Vars", X = 32, Y = 80 },
	},

	-- Items Menu
	{
		-- Box
		Width = 200,
		Height = 223,
		
		-- Items
		{ X = 32, Y = 32 },
		{ X = 32, Y = 38 },
		{ X = 32, Y = 44 },
		{ X = 32, Y = 50 },
		{ X = 32, Y = 56 },
		{ X = 32, Y = 62 },
		{ X = 32, Y = 68 },
		{ X = 32, Y = 74 },
		{ X = 32, Y = 80 },
		{ X = 32, Y = 86 },
		{ X = 32, Y = 92 },
		{ X = 32, Y = 98 },
		{ X = 32, Y = 104 },
		{ X = 32, Y = 110 },
		{ X = 32, Y = 116 },
		{ X = 32, Y = 122 },
		{ X = 32, Y = 128 },
		{ X = 32, Y = 134 },
		{ X = 32, Y = 140 },
		{ X = 32, Y = 146 },
		{ X = 32, Y = 152 },
		{ X = 32, Y = 158 },
		{ X = 32, Y = 164 },
		{ X = 32, Y = 170 },
		{ X = 32, Y = 176 },
		{ X = 32, Y = 182 },
		{ X = 32, Y = 188 },
		{ X = 32, Y = 194 },
		{ X = 32, Y = 200 },
		{ X = 32, Y = 206 },
		
		-- Header
		{ Header = true, Text = "Inventory", X = 8, Y = 16 },
		
		-- Input
		Input = function()
			-- Left/Right
			if KeyPressed("LeftArrow") then
				if SubIndex == 0 then -- Item
					EditItem(Index - 1, memory.readbyte(Address.Items + Index - 1) - 1)
				end
				if SubIndex == 1 then -- Equipment
					EditEquipment(Index - 1, memory.readbyte(Address.Equipment + Index - 1) - 1)
				end
				if SubIndex == 2 then -- Special Items
					EditSpecialItem(Index - 1, memory.readbyte(Address.SpecialItems + Index - 1) - 1)
				end
				if SubIndex == 3 then -- Misc
					if Index == 1 then memory.writebyte(Address.FP, memory.readbyte(Address.FP) - 1) 		 	   end
					if Index == 2 then memory.writebyte(Address.FP + 1, memory.readbyte(Address.FP + 1) - 1) 	   end
					if Index == 3 then memory.write_s16_le(Address.Coins, memory.read_s16_le(Address.Coins) - 1) 	 	   end
					if Index == 4 then memory.writebyte(Address.FrogCoins, memory.readbyte(Address.FrogCoins) - 1) end
				end
			end
			if KeyPressed("RightArrow") then
				if SubIndex == 0 then -- Item
					EditItem(Index - 1, memory.readbyte(Address.Items + Index - 1) + 1)
				end
				if SubIndex == 1 then -- Equipment
					EditEquipment(Index - 1, memory.readbyte(Address.Equipment + Index - 1) + 1)
				end
				if SubIndex == 2 then -- Special Items
					EditSpecialItem(Index - 1, memory.readbyte(Address.SpecialItems + Index - 1) + 1)
				end
				if SubIndex == 3 then -- Misc
					if Index == 1 then memory.writebyte(Address.FP, memory.readbyte(Address.FP) + 1) 			   end
					if Index == 2 then memory.writebyte(Address.FP + 1, memory.readbyte(Address.FP + 1) + 1) 	   end
					if Index == 3 then memory.write_s16_le(Address.Coins, memory.read_s16_le(Address.Coins) + 1) 		   end
					if Index == 4 then memory.writebyte(Address.FrogCoins, memory.readbyte(Address.FrogCoins) + 1) end
				end
			end
			
			-- Switch Item Type
			if KeyPressed("Q") then
				if SubIndex > 0 then
					SubIndex = SubIndex - 1
				end
			end
			if KeyPressed("W") then
				if SubIndex < 3 then
					SubIndex = SubIndex + 1
				end
			end
            
            -- Clipboard
			if KeyPressed("E") then
				if SubIndex == 0 then -- Item
					Clipboard = memory.readbyte(Address.Items + Index - 1)
				end
				if SubIndex == 1 then -- Equipment
					Clipboard = memory.readbyte(Address.Equipment + Index - 1)
				end
				if SubIndex == 2 then -- Special Items
					Clipboard = memory.readbyte(Address.SpecialItems + Index - 1)
				end
            end
			if KeyPressed("D") then
				if SubIndex == 0 then -- Item
					memory.writebyte(Address.Items + Index - 1, Clipboard)
				end
				if SubIndex == 1 then -- Equipment
					memory.writebyte(Address.Equipment + Index - 1, Clipboard)
				end
				if SubIndex == 2 then -- Special Items
					memory.writebyte(Address.SpecialItems + Index - 1, Clipboard)
				end
            end
		end,
		
		-- Update
		Update = function()
			if SubIndex == 0 then -- Items
				for i = 1, 30 do
					local value = memory.readbyte(Address.Items + (i - 1))
					Menu[2][i].Text = string.format("Item %d: %d (%s)", i, value, ItemNames[value])
				end
			end
			if SubIndex == 1 then -- Equipment
				for i = 1, 30 do
					local value = memory.readbyte(Address.Equipment + (i - 1))
					Menu[2][i].Text = string.format("Equip %d: %d (%s)", i, value, ItemNames[value])
				end
			end
			if SubIndex == 2 then -- Special Items
				for i = 1, 15 do
					local value = memory.readbyte(Address.SpecialItems + (i - 1))
					Menu[2][i].Text = string.format("Special Item %d: %d (%s)", i, value, ItemNames[value])
				end
				-- Hide the rest
				for i = 16, 30 do
					Menu[2][i].Text = ""
				end
			end
			if SubIndex == 3 then -- Other
				local fp = memory.readbyte(Address.FP)
				local fpmax = memory.readbyte(Address.FP + 0x1)
				local coins = memory.read_s16_le(Address.Coins)
				local frogcoins = memory.readbyte(Address.FrogCoins)
				Menu[2][1].Text = "Flower Points: " .. fp .. "/" .. fpmax
				Menu[2][2].Text = "Max Flower Points: " .. fpmax
				Menu[2][3].Text = "Coins: " .. coins
				Menu[2][4].Text = "Frog Coins: " .. frogcoins
				-- Hide the rest
				for i = 5, 30 do
					Menu[2][i].Text = nil
				end
			end
			
			-- Header
			if SubIndex == 0 then Menu[2][31].Text = "Inventory - Items (1/4)"         end
			if SubIndex == 1 then Menu[2][31].Text = "Inventory - Equipment (2/4)"     end
			if SubIndex == 2 then Menu[2][31].Text = "Inventory - Special Items (3/4)" end
			if SubIndex == 3 then Menu[2][31].Text = "Inventory - Misc (4/4)" 		   end
			
			-- Prevent index overflow on specific sub-pages
			if SubIndex == 2 and Index > 15 then Index = 15 end
			if SubIndex == 3 and Index > 4  then Index = 4  end
		end
	},

	-- Character Menu
	{
		-- Box
		Width = 230,
		Height = 170,

		-- Stats
		{ X = 32, Y = 32 }, 	-- Level
		{ X = 32, Y = 48 }, 	-- Current HP
		{ X = 32, Y = 56 },		-- Max HP
		{ X = 32, Y = 72 },		-- Speed
		{ X = 32, Y = 80 }, 	-- Attack
		{ X = 32, Y = 88 }, 	-- Defense
		{ X = 32, Y = 96 },		-- Magic Attack
		{ X = 32, Y = 104 },	-- Magic Defense
		{ X = 32, Y = 120 },	-- Experience
		{ X = 32, Y = 136 }, 	-- Weapon
		{ X = 32, Y = 144 }, 	-- Armor
		{ X = 32, Y = 152 },	-- Accessory

		-- Header
		{ Header = true, Text = "Character", X = 8, Y = 16 },
		
		-- Input
		Input = function()
			-- Left/Right
			if KeyPressed("LeftArrow") then
				if Index == 1  then EditChar(SubIndex, 0x0, -1) end
				if Index == 2  then EditChar(SubIndex, 0x1, -1) end
				if Index == 3  then EditChar(SubIndex, 0x3, -1) end
				if Index == 4  then EditChar(SubIndex, 0x5, -1) end
				if Index == 5  then EditChar(SubIndex, 0x6, -1) end
				if Index == 6  then EditChar(SubIndex, 0x7, -1) end
				if Index == 7  then EditChar(SubIndex, 0x8, -1) end
				if Index == 8  then EditChar(SubIndex, 0x9, -1) end
				if Index == 9  then EditChar(SubIndex, 0xA, -1) end
				if Index == 10 then EditChar(SubIndex, 0xB, -1) end
				if Index == 11 then EditChar(SubIndex, 0xC, -1) end
				if Index == 12 then EditChar(SubIndex, 0xD, -1) end
			end
			if KeyPressed("RightArrow") then
				if Index == 1  then EditChar(SubIndex, 0x0, 1) end
				if Index == 2  then EditChar(SubIndex, 0x1, 1) end
				if Index == 3  then EditChar(SubIndex, 0x3, 1) end
				if Index == 4  then EditChar(SubIndex, 0x5, 1) end
				if Index == 5  then EditChar(SubIndex, 0x6, 1) end
				if Index == 6  then EditChar(SubIndex, 0x7, 1) end
				if Index == 7  then EditChar(SubIndex, 0x8, 1) end
				if Index == 8  then EditChar(SubIndex, 0x9, 1) end
				if Index == 9  then EditChar(SubIndex, 0xA, 1) end
				if Index == 10 then EditChar(SubIndex, 0xB, 1) end
				if Index == 11 then EditChar(SubIndex, 0xC, 1) end
				if Index == 12 then EditChar(SubIndex, 0xD, 1) end
			end

			-- Switch Character
			if KeyPressed("Q") then
				if SubIndex > 0 then
					SubIndex = SubIndex - 1
				end
			end
			if KeyPressed("W") then
				if SubIndex < 4 then
					SubIndex = SubIndex + 1
				end
			end
		end,

		-- Update
		Update = function()
			local level = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x0)
			local hp = memory.read_s16_le(Address.Characters + (SubIndex * 0x14) + 0x1)
			local hpmax = memory.read_s16_le(Address.Characters + (SubIndex * 0x14) + 0x3)
			local speed = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x5)
			local attack = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x6)
			local defense = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x7)
			local magicattack = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x8)
			local magicdefense = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x9)
			local experience = memory.read_s16_le(Address.Characters + (SubIndex * 0x14) + 0xA)
			local weapon = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0xC)
			local armor = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0xD)
			local accessory = memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0xE)
			
			Menu[3][1].Text = "Level: " .. level
			Menu[3][2].Text = "HP: " .. hp .. "/" .. hpmax
			Menu[3][3].Text = "Max HP: " .. hpmax
			Menu[3][4].Text = "Speed: " .. speed
			Menu[3][5].Text = "Attack: " .. attack
			Menu[3][6].Text = "Defense: " .. defense
			Menu[3][7].Text = "Magic Attack: " .. magicattack
			Menu[3][8].Text = "Magic Defense: " .. magicdefense
			Menu[3][9].Text = "Experience: " .. experience
			Menu[3][10].Text = "Weapon: " .. weapon .. " (" .. ItemNames[weapon] .. ")"
			Menu[3][11].Text = "Armor: " .. armor .. " (" .. ItemNames[armor] .. ")"
			Menu[3][12].Text = "Accessory: " .. accessory .. " (" .. ItemNames[accessory] .. ")"
			
			-- Header
			if SubIndex == 0 then Menu[3][13].Text = "Character - Mario (1/5)"  end
			if SubIndex == 1 then Menu[3][13].Text = "Character - Peach (2/5)"  end
			if SubIndex == 2 then Menu[3][13].Text = "Character - Bowser (3/5)" end
			if SubIndex == 3 then Menu[3][13].Text = "Character - Geno (4/5)"   end
			if SubIndex == 4 then Menu[3][13].Text = "Character - Mallow (5/5)" end
			
			-- Bars
			local healthpct = (memory.read_s16_le(Address.Characters + (SubIndex * 0x14) + 0x1) / memory.read_s16_le(Address.Characters + (SubIndex * 0x14) + 0x3)) * 100
			local speedpct = (memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x5) / 255) * 100
			local attackpct = (memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x6) / 255) * 100
			local defensepct = (memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x7) / 255) * 100
			local magicattackpct = (memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x8) / 255) * 100
			local magicdefensepct = (memory.readbyte(Address.Characters + (SubIndex * 0x14) + 0x9) / 255) * 100
			local experiencepct = (memory.read_s16_le(Address.Characters + (SubIndex * 0x14) + 0xA) / 9999) * 100
			DrawBar(112, 48, healthpct, 5, "lime")
			DrawBar(112, 72, speedpct, 5, "yellow")
			DrawBar(112, 80, attackpct, 5, "red")
			DrawBar(112, 88, defensepct, 5, "blue")
			DrawBar(112, 96, magicattackpct, 5, "purple")
			DrawBar(112, 104, magicdefensepct, 5, "cyan")
			DrawBar(112, 120, experiencepct, 5, "white")
		end,
	},
	
	-- Battle Menu
	{
		-- Box
		Width = 250,
		Height = 160,
		
		-- Battle Vars
		{ X = 32, Y = 24 },
		{ X = 32, Y = 32 },
		{ X = 32, Y = 40 },
		{ X = 32, Y = 48 },

		-- Enemy
		{ X = 136, Y = 24 },
		{ X = 136, Y = 40 },
		{ X = 136, Y = 48 },
		{ X = 136, Y = 64 },
		{ X = 136, Y = 72 },
		{ X = 136, Y = 80 },
		{ X = 136, Y = 88 },
		{ X = 136, Y = 96 },
		{ X = 136, Y = 112 },
		{ X = 136, Y = 120 },
		{ X = 136, Y = 136 },
		{ X = 136, Y = 144 },
		
		-- Item Counters
		{ Skip = true, X = 32, Y = 72 },
		{ Skip = true, X = 32, Y = 80 },
		{ Skip = true, X = 32, Y = 88 },
		{ Skip = true, X = 32, Y = 96 },
		
		-- Headers
		{ Header = true, Text = "Battle Vars", X = 8, Y = 16 },
		{ Header = true, Text = "Enemy", X = 128, Y = 16 },
		{ Header = true, Text = "Item Counters", X = 8, Y = 64 },
		
		-- Input
		Input = function()
			-- Left/Right
			if KeyPressed("LeftArrow") then
				if Index == 1  then memory.writebyte(Address.Spell, memory.readbyte(Address.Spell) - 1) 														end
				if Index == 2  then memory.writebyte(Address.TotalXP, memory.readbyte(Address.TotalXP) - 1) 													end
				if Index == 3  then memory.writebyte(Address.TotalCoins, memory.readbyte(Address.TotalCoins) - 1)												end
				if Index == 4  then memory.writebyte(Address.BattleEvent, memory.readbyte(Address.BattleEvent) - 1)												end
				if Index == 5  then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1) - 1)	end
				if Index == 6  then memory.write_s16_le(Address.Enemies + (SubIndex * 128) + 0x11, memory.read_s16_le(Address.Enemies + (SubIndex * 128) + 0x11) - 1) end
				if Index == 7  then memory.write_s16_le(Address.Enemies + (SubIndex * 128) + 0x13, memory.read_s16_le(Address.Enemies + (SubIndex * 128) + 0x13) - 1) end
				if Index == 8  then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x15, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x15) - 1) end
				if Index == 9  then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x16, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x16) - 1) end
				if Index == 10 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x17, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x17) - 1) end
				if Index == 11 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x18, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x18) - 1) end
				if Index == 12 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x19, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x19) - 1) end
				if Index == 13 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1A, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1A) - 1) end
				if Index == 14 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1B, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1B) - 1) end
				if Index == 15 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1C, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1C) - 1) end
				if Index == 16 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1D, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1D) - 1) end
			end
			if KeyPressed("RightArrow") then
				if Index == 1  then memory.writebyte(Address.Spell, memory.readbyte(Address.Spell) + 1) 														end
				if Index == 2  then memory.writebyte(Address.TotalXP, memory.readbyte(Address.TotalXP) + 1) 													end
				if Index == 3  then memory.writebyte(Address.TotalCoins, memory.readbyte(Address.TotalCoins) + 1) 												end
				if Index == 4  then memory.writebyte(Address.BattleEvent, memory.readbyte(Address.BattleEvent) + 1) 											end
				if Index == 5  then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1) + 1) 	end
				if Index == 6  then memory.write_s16_le(Address.Enemies + (SubIndex * 128) + 0x11, memory.read_s16_le(Address.Enemies + (SubIndex * 128) + 0x11) + 1) end
				if Index == 7  then memory.write_s16_le(Address.Enemies + (SubIndex * 128) + 0x13, memory.read_s16_le(Address.Enemies + (SubIndex * 128) + 0x13) + 1) end
				if Index == 8  then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x15, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x15) + 1) end
				if Index == 9  then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x16, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x16) + 1) end
				if Index == 10 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x17, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x17) + 1) end
				if Index == 11 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x18, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x18) + 1) end
				if Index == 12 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x19, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x19) + 1) end
				if Index == 13 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1A, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1A) + 1) end
				if Index == 14 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1B, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1B) + 1) end
				if Index == 15 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1C, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1C) + 1) end
				if Index == 16 then memory.writebyte(Address.Enemies + (SubIndex * 128) + 0x1D, memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1D) + 1) end
			end

			-- Switch Enemy
			if KeyPressed("Q") then
				if SubIndex > 0 then
					SubIndex = SubIndex - 1
				end
			end
			if KeyPressed("W") then
				if SubIndex < 7 then
					SubIndex = SubIndex + 1
				end
			end
		end,
		
		-- Update
		Update = function()
			local spell = memory.readbyte(Address.Spell)
			local xp = memory.readbyte(Address.TotalXP)
			local coins = memory.readbyte(Address.TotalCoins)
			local event = memory.readbyte(Address.BattleEvent)
			local monster = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1)
			local hp = memory.read_s16_le(Address.Enemies + (SubIndex * 128) + 0x11)
			local hpmax = memory.read_s16_le(Address.Enemies + (SubIndex * 128) + 0x13)
			local speed = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x15)
			local attack = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x16)
			local defense = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x17)
			local magicattack = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x18)
			local magicdefense = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x19)
			local evade = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1A)
			local magicevade = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1B)
			local fp = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1C)
			local flags = memory.readbyte(Address.Enemies + (SubIndex * 128) + 0x1D)
			local superjumps = memory.readbyte(Address.JumpCounter)
			local mysteryegg = memory.readbyte(Address.MysteryEggCounter)
			local lambslure = memory.readbyte(Address.LambsLureCounter)
			local luckyjewel = memory.readbyte(Address.LuckyJewelCounter)
			
			-- Battle Vars
			Menu[4][1].Text = "Special: " .. spell
			Menu[4][2].Text = "Total XP: " .. xp
			Menu[4][3].Text = "Total Coins: " .. coins
			Menu[4][4].Text = "Battle Event: " .. event

			-- Enemy
			Menu[4][5].Text = "Monster: " .. monster .. " (" .. EnemyNames[monster] .. ")"
			Menu[4][6].Text = "HP: " .. hp .. "/" .. hpmax
			Menu[4][7].Text = "Max HP: " .. hpmax
			Menu[4][8].Text = "Speed: " .. speed
			Menu[4][9].Text = "Attack: " .. attack
			Menu[4][10].Text = "Defense: " .. defense
			Menu[4][11].Text = "Magic Attack: " .. magicattack
			Menu[4][12].Text = "Magic Defense: " .. magicdefense
			Menu[4][13].Text = "Evade Chance: " .. evade .. "%"
			Menu[4][14].Text = "Magic Evade Chance: " .. magicevade .. "%"
			Menu[4][15].Text = "FP: " .. fp
			Menu[4][16].Text = "Flags: " .. flags
			Menu[4][22].Text = "Enemy " .. SubIndex + 1 .. "/" .. 8
			
			-- Item Counters
			Menu[4][17].Text = "Super Jump: " .. superjumps
			Menu[4][18].Text = "Mystery Egg: " .. mysteryegg
			Menu[4][19].Text = "Lamb's Lure: " .. lambslure
			Menu[4][20].Text = "Lucky Jewel: " .. luckyjewel
		end
	},
    
	-- World Menu
	{
		-- Box
		Width = 250,
		Height = 140,

		-- Coordinates
		{ X = 32, Y = 24 },
		{ X = 32, Y = 32 },
		{ X = 32, Y = 40 },

		-- Player Modifiers
		{ X = 32, Y = 72 },

		-- World Vars
		{ X = 128, Y = 24 },
		{ Skip = true, X = 128, Y = 32 },
		{ Skip = true, X = 128, Y = 40 },

		-- Header
		{ Header = true, Text = "World Coordinates", X = 8, Y = 16 },
		{ Header = true, Text = "Player Modifiers", X = 8, Y = 64 },
		{ Header = true, Text = "World Vars", X = 128, Y = 16 },
		
		-- Input
		Input = function()
			-- Left/Right
			if KeyPressed("LeftArrow") then
				if Index == 1 then memory.write_s16_le(Address.X, memory.read_s16_le(Address.X) - 8) 							   end
				if Index == 2 then memory.write_s16_le(Address.Y, memory.read_s16_le(Address.Y) - 8) 							   end
				if Index == 3 then memory.write_s16_le(Address.Z, memory.read_s16_le(Address.Z) - 8) 							   end
				if Index == 4 then memory.write_s16_le(Address.Invincible, 0) 					   							   end
				if Index == 5 then memory.write_s16_le(Address.CurrentLocation, memory.readbyte(Address.CurrentLocation) - 1) end
			end
			if KeyPressed("RightArrow") then
				if Index == 1 then memory.write_s16_le(Address.X, memory.read_s16_le(Address.X) + 8) 							   end
				if Index == 2 then memory.write_s16_le(Address.Y, memory.read_s16_le(Address.Y) + 8) 							   end
				if Index == 3 then memory.write_s16_le(Address.Z, memory.read_s16_le(Address.Z) + 8) 							   end
				if Index == 4 then memory.write_s16_le(Address.Invincible, 1) 												   end
				if Index == 5 then memory.write_s16_le(Address.CurrentLocation, memory.readbyte(Address.CurrentLocation) + 1) end
			end
		end,
		
		-- Update
		Update = function()
			local x = memory.read_s16_le(Address.X)
			local y = memory.read_s16_le(Address.Y)
			local z = memory.read_s16_le(Address.Z)
			local map = memory.readbyte(Address.CurrentLocation)
			local music = memory.readbyte(Address.Music)
			local soundeffect = memory.readbyte(Address.SoundEffect)
			local invincible = memory.readbyte(Address.Invincible)
			
			Menu[5][1].Text = "X: " .. x
			Menu[5][2].Text = "Y: " .. y
			Menu[5][3].Text = "Z: " .. z
			Menu[5][4].Text = "Invincible: " .. GetOnOff(invincible)
			Menu[5][5].Text = "Map Location: " .. map
			Menu[5][6].Text = "Music: " .. music
			Menu[5][7].Text = "Sound Effect: " .. soundeffect
		end
	},
		
	-- System Menu
	{
		-- Box
		Width = 250,
		Height = 125,
	},
}

function PreInput()
	Input = input.get()
end

function PostInput()
	OldInput = Input
end

function KeyPressed(key)
	if not Open and Key == 'X' then return end
	
	-- Handle key repeat delay
	if Input[key] then
		InputTimer = InputTimer + 1
	elseif not Input[key] and OldInput[key] then
		InputTimer = 0
	end
	
	if InputTimer >= RepeatDelay then
		return Input[key]
	else
		return Input[key] and not OldInput[key]
	end
end

function CheckInput()
	-- Toggle Menu
	if KeyPressed("F") then
        Open = not Open
	end
    
	if not Open then return end
	
    -- Cursor Up
	if KeyPressed("UpArrow") and Index > 1 then
		Index = Index - 1
	end
	
	-- Cursor Down
	if KeyPressed("DownArrow") and Index < #Menu[Page] then
		Index = Index + 1
	end
	
	-- Back
	if KeyPressed("R") then
		Page = 1
		Index = 1
		SubIndex = 0
	end
	
	-- Select/Action
	if KeyPressed("A") then
		if Page == 1 then -- Main Menu
			Page = Index + 1
			Index = 1
			SubIndex = 0
		end
	end
	
	-- Iterate through menu Input() functions
	for key, value in pairs(Menu[Page]) do
		if key == "Input" then
			if type(value) == "function" then
				Menu[Page]:Input()
			end
		end
	end

	-- Cursor Handling for Headers and Skipped elements
	if Menu[Page][Index] ~= nil then
		for key, value in pairs(Menu[Page][Index]) do
			if key == "Header" or key == "Skip" then
				if (value) then
					Index = Index - 1
				end
			end
		end
	end
end

function Draw()
	if not Open then return end
	
	-- Box
	gui.drawBox(0, 0, Menu[Page].Width, Menu[Page].Height, 0x4F4F0000, 0xAF7F0000)

	-- Menu Items
	for item = 1, #Menu[Page] do
		-- Cursor
		if item == Index then
			gui.pixelText(Menu[Page][item].X - 24, Menu[Page][item].Y, "--->", 0xFFFFFFFF)
		end
		
		-- Text
		if Menu[Page][item].Text ~= nil then
			gui.pixelText(Menu[Page][item].X, Menu[Page][item].Y, Menu[Page][item].Text, 0xFFCFCFFF)
		end
	end
end

-- Update
function Update()
	if not Open then return end
	
	-- Iterate through menu Update() functions
	for key, value in pairs(Menu[Page]) do
		if key == "Update" then
			if type(value) == "function" then
				Menu[Page]:Update()
			end
		end
	end
end

-- Main Loop
while true do
    -- Draw
    Draw()
	
    -- Update menu and vars
	Update()

	-- Pre Input
	PreInput()

	-- Check Input
	CheckInput()
    
	-- Advance a frame
	emu.frameadvance()
	
	-- Post Input
	PostInput()
end
